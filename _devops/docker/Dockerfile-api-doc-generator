FROM mcr.microsoft.com/dotnet/sdk:8.0

# Gerekli paketler
RUN apt-get update && apt-get install -y \
    openssh-client \
    git

# SSH klasörü
RUN mkdir -p /root/.ssh

# ArfBlocks CLI kurulumu
RUN dotnet tool install --global Arfware.ArfBlocks-cli --version 2.0.0
ENV PATH="${PATH}:/root/.dotnet/tools"

# Build context'e geç
WORKDIR /src/backend

# Kodları kopyala
COPY . .

# SSH key ve host tanımları sonradan build arg ile değil COPY ile eklenecek
COPY _devops/ssh/id_rsa_mobileapp /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

# ArfBlocks generate-docs çalıştır (hirovo ve iam ayrı ayrı)
RUN mkdir -p /src/webapp/common/hirovo-api/src/api/business_modules/hirovo
RUN mkdir -p /src/webapp/common/hirovo-api/src/api/base_modules/iam

RUN arfblocks-cli exec --file /src/backend/_devops/arfblocks-cli/hirovo.arfblocks-cli.json
RUN arfblocks-cli exec --file /src/backend/_devops/arfblocks-cli/iam.arfblocks-cli.json
