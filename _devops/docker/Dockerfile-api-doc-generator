# Base image
FROM mcr.microsoft.com/dotnet/sdk:8.0

# SSH, Git, diğer ihtiyaçlar
RUN apt-get update && apt-get install -y \
    openssh-client \
    git

# SSH klasörünü oluştur
RUN mkdir -p /root/.ssh

# ArfBlocks CLI yükle
RUN dotnet tool install --global Arfware.ArfBlocks-cli --version 2.0.0
ENV PATH="${PATH}:/root/.dotnet/tools"

# GIT ayarları
ARG git_username
ARG git_password
RUN git config --global user.name "CI/CD-BOT"
RUN git config --global user.email "bot@hirovo.com"
RUN git config --global pull.rebase false
RUN git config --global push.default matching
RUN git config --global http.sslVerify false

# Backend kaynaklarını kopyala
WORKDIR /src/backend
COPY . .

# SSH key'i kopyala (Jenkins pipeline’dan geliyor)
COPY _devops/ssh/id_rsa_mobileapp /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa

# GitHub host’u ekle
RUN ssh-keyscan github.com >> /root/.ssh/known_hosts

# ArfBlocks çıktısı için gerekli dizinleri oluştur
RUN mkdir -p /src/webapp/common/hirovo-api/src/api/business_modules/hirovo
RUN mkdir -p /src/webapp/common/hirovo-api/src/api/base_modules/iam

# Hirovo modülü ArfBlocks dökümanını oluştur
RUN arfblocks-cli exec --file /src/backend/_devops/arfblocks-cli/hirovo.arfblocks-cli.json

# IAM modülü ArfBlocks dökümanını oluştur
RUN arfblocks-cli exec --file /src/backend/_devops/arfblocks-cli/iam.arfblocks-cli.json

# ErrorCode Export işlemini çalıştır
RUN dotnet run --project Jobs/SpecialPurpose/DevTasks/ErrorCodeExporter/

# Üretilen dosyaları frontend ve mobile dizinlerine kopyala
RUN cp -r /src/webapp/common /src/backend/_devops/tmp/webapp/
