pipeline {
    agent any

    environment {
        TAG = "${BUILD_NUMBER}_COM${env.GIT_COMMIT.substring(0, 6)}"
        NAMESPACE = 'maden-staging'
    }

    stages {
        stage('Prepare Web/Mobile Context') {
            steps {
                sh '''
                    mkdir -p ./_devops/tmp/webapp
                    mkdir -p ./_devops/tmp/mobileapp
                    cp -r /maden/maden-frontend/common ./_devops/tmp/webapp/
                    cp -r /maden/mobileapp/common ./_devops/tmp/mobileapp/
                '''
            }
        }

        stage('API Documentation Generator') {
            steps {
                withCredentials([
                    sshUserPrivateKey(credentialsId: 'mobileapp-ssh-key', keyFileVariable: 'SSH_KEY_PATH'),
                    usernamePassword(credentialsId: 'gitlab-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
                ]) {
                    sh '''
                        mkdir -p _devops/ssh
                        cp "$SSH_KEY_PATH" _devops/ssh/id_rsa_mobileapp
                        chmod 600 _devops/ssh/id_rsa_mobileapp

                        docker build \
                        -t registry.git.hirovo.com.tr/arfblocks-cli:$TAG \
                        --build-arg git_username=$USERNAME \
                        --build-arg git_password=$PASSWORD \
                        -f _devops/docker/Dockerfile-api-doc-generator .
                    '''
                }
            }
        }

        stage('Clear Produced Dangling Containers/Layers') {
            steps {
                sh("docker images | grep '<none>' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker images | grep 'registry.git.hirovo.com.tr' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker system prune --all -f")
            }
        }

        stage('Send Success Message') {
            steps {
                sh("echo '✅ Hirovo API Docs Pipeline Success'")
            }
        }
    }

    post {
        always {
            sh("echo '⏹ Pipeline Completed'")
        }
        failure {
            sh("echo '❌ Pipeline Failed'")
        }
    }
}
