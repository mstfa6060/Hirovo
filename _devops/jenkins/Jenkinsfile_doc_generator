pipeline {
    agent any

    environment {
        TAG = "${BUILD_NUMBER}_COM${env.GIT_COMMIT.substring(0, 6)}"
        NAMESPACE = 'maden-staging'
    }

    stages {
        stage('API Documentation Generator') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'USERNAME',
                        passwordVariable: 'PASSWORD'
                    ),
                    sshUserPrivateKey(
                        credentialsId: 'mobileapp-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )
                ]) {
                    sh '''
                        mkdir -p _devops/ssh
                        base64 "$SSH_KEY" > _devops/ssh/id_rsa_mobileapp.b64
                        base64 -d _devops/ssh/id_rsa_mobileapp.b64 > _devops/ssh/id_rsa_mobileapp
                        chmod 600 _devops/ssh/id_rsa_mobileapp
                    '''

                    sh """
                        docker build \
                        -t registry.git.hirovo.com.tr/arfblocks-cli:$TAG \
                        --build-arg git_username=$USERNAME \
                        --build-arg git_password=$PASSWORD \
                        -f _devops/docker/Dockerfile-api-doc-generator .
                    """
                }
            }
        }

        stage('Clear Produced Dangling Containers/Layers') {
            steps {
                sh("docker images | grep '<none>' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker images | grep 'registry.git.hirovo.com.tr' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker system prune --all -f")
            }
        }

        stage('Send Success Mail') {
            steps {
                sh("echo '‚úÖ Hirovo API Docs Pipeline Success'")
                mail(
                    body: "‚úî Hirovo: ArfBlocks API dok√ºmantasyonu ba≈üarƒ±yla olu≈üturuldu ve frontend repo'lara g√∂nderildi. Tag: ${TAG}",
                    from: 'bot@hirovo.com',
                    subject: 'Jenkins: Hirovo API Docs Olu≈üturma Ba≈üarƒ±lƒ±',
                    to: 'dev@hirovo.com'
                )
            }
        }
    }

    post {
        always {
            sh("echo '‚èπ Pipeline Completed'")
        }
        failure {
            sh("echo '‚ùå Pipeline Failed'")
            mail(
                body: "üö® HATA: Hirovo API dok√ºmantasyonu olu≈üturulamadƒ±! Tag: ${TAG}",
                from: 'bot@hirovo.com',
                subject: 'Jenkins - Uyarƒ±: Hirovo API Docs Olu≈üturma Ba≈üarƒ±sƒ±z',
                to: 'dev@hirovo.com'
            )
        }
    }
}
