pipeline {
    agent any

    environment {
        TAG = "${BUILD_NUMBER}_COM${env.GIT_COMMIT.substring(0, 6)}"
        NAMESPACE = 'maden-staging'
    }

    stages {
        stage('Prepare Web/Mobile Context') {
            steps {
                sh '''
                    mkdir -p ./_devops/tmp/webapp
                    mkdir -p ./_devops/tmp/mobileapp
                    cp -r /maden/maden-frontend/common ./_devops/tmp/webapp/
                    cp -r /maden/mobileapp/common ./_devops/tmp/mobileapp/
                '''
            }
        }

        stage('API Documentation Generator') {
            steps {
                withCredentials([ 
                    sshUserPrivateKey(credentialsId: 'mobileapp-deploy-key', keyFileVariable: 'SSH_KEY_PATH', usernameVariable: 'SSH_USERNAME'), 
                    usernamePassword(credentialsId: 'c1cec859-9a72-4a26-a997-a8ce7c6189e9', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
                ]) {
                    sh '''
                        mkdir -p _devops/ssh
                        cp "$SSH_KEY_PATH" _devops/ssh/id_rsa_mobileapp
                        chmod 600 _devops/ssh/id_rsa_mobileapp

                        docker build \
                        -t registry.git.hirovo.com.tr/arfblocks-cli:$TAG \
                        --build-arg git_username=$USERNAME \
                        --build-arg git_password=$PASSWORD \
                        -f _devops/docker/Dockerfile-api-doc-generator .
                    '''
                }
            }
        }

        stage('Push ArfBlocks Docs to Frontend & Mobile') {
            steps {
                withCredentials([ 
                    sshUserPrivateKey(credentialsId: 'mobileapp-deploy-key', keyFileVariable: 'SSH_KEY_PATH', usernameVariable: 'SSH_USERNAME'), 
                    usernamePassword(credentialsId: 'c1cec859-9a72-4a26-a997-a8ce7c6189e9', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
                ])  {
                    sh '''
                        export GIT_SSH_COMMAND="ssh -i $SSH_KEY_PATH -o StrictHostKeyChecking=no"

                        cd _devops/tmp/webapp
                        git init
                        git remote remove origin || true
                        git remote add origin git@github.com:mstfa6060/maden-frontend.git
                        git checkout -B main
                        git config user.name "CI/CD-BOT"
                        git config user.email "bot@hirovo.com"
                        git add .
                        git commit -m "üì¶ ArfBlocks API dok√ºmantasyonu g√ºncellendi - $TAG"
                        git push origin main --force

                        cd ../mobileapp
                        git init
                        git remote remove origin || true
                        git remote add origin git@github.com:mstfa6060/mobileapp.git
                        git checkout -B main
                        git config user.name "CI/CD-BOT"
                        git config user.email "bot@hirovo.com"
                        git add .
                        git commit -m "üì¶ Mobil API dok√ºmantasyonu g√ºncellendi - $TAG"
                        git push origin main --force
                    '''
                }
            }
        }

        stage('Clear Produced Dangling Containers/Layers') {
            steps {
                sh("docker images | grep '<none>' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker images | grep 'registry.git.hirovo.com.tr' | awk '{print \$3}' | xargs -I {} docker rmi -f {} || true")
                sh("docker system prune --all -f")
            }
        }

        stage('Send Success Message') {
            steps {
                sh("echo '‚úÖ Hirovo API Docs Pipeline Success'")
            }
        }
    }

    post {
        always {
            sh("echo '‚èπ Pipeline Completed'")
        }
        failure {
            sh("echo '‚ùå Pipeline Failed'")
        }
    }
}
