pipeline {
    agent any

    environment {
        DOCKER_IMAGE_NAME = "mstfa6060/hirovo-api"
        DOCKERFILE_PATH = "_devops/docker/Dockerfile-modules-hirovo"
        BUILD_CONTEXT = "."
    }

    stages {
        stage('Prepare ArfBlocks CLI') {
            steps {
                sh '''
                    dotnet new tool-manifest || true
                    dotnet tool install Arfware.ArfBlocks-cli --version 2.0.0 || true
                    dotnet tool restore
                '''
            }
        }

        stage('Create CLI Output Folders') {
            steps {
                sh '''
                    mkdir -p artifacts/cli-output/iam
                    mkdir -p artifacts/cli-output/workers
                '''
            }
        }

        stage('Generate IAM Docs') {
            steps {
                sh 'dotnet tool run arfblocks-cli exec --file _devops/arfblocks-cli/iam.arfblocks-cli.json'
            }
        }

        stage('Generate Workers Docs') {
            steps {
                sh 'dotnet tool run arfblocks-cli exec --file _devops/arfblocks-cli/hirovo.arfblocks-cli.json'
            }
        }
 

        stage('Docker Build & Push') {
            steps {
                sh '''
                    docker build -t $DOCKER_IMAGE_NAME:latest -f $DOCKERFILE_PATH $BUILD_CONTEXT
                    docker push $DOCKER_IMAGE_NAME:latest
                '''
            }
        }
    }
}
