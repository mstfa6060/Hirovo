pipeline {
    agent any

    environment {
        TAG = "${BUILD_NUMBER}_COM${env.GIT_COMMIT.substring(0, 6)}"
    }

    stages {
        stage('API Documentation Generator') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'dockerhub-credentials',
                        usernameVariable: 'USERNAME',
                        passwordVariable: 'PASSWORD'
                    ),
                    sshUserPrivateKey(
                        credentialsId: 'mobileapp-ssh-key',
                        keyFileVariable: 'SSH_KEY_PATH',
                        usernameVariable: 'SSH_USER'
                    )
                ]) {
                    sh '''
                        mkdir -p _devops/ssh
                        cp "$SSH_KEY_PATH" _devops/ssh/id_rsa_mobileapp
                        chmod 600 _devops/ssh/id_rsa_mobileapp
                    '''

                    sh """
                        docker build \
                        -t registry.git.hirovo.com.tr/arfblocks-cli:$TAG \
                        --build-arg git_username=$USERNAME \
                        --build-arg git_password=$PASSWORD \
                        -f _devops/docker/Dockerfile-api-doc-generator .
                    """
                }
            }
        }
    }

    post {
        always {
            sh("echo '⏹ Pipeline Completed'")
        }
        failure {
            sh("echo '❌ Pipeline Failed'")
        }
    }
}
