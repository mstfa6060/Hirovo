pipeline {
    agent any

    stages {
        stage('Prepare ArfBlocks CLI') {
            steps {
                sh '''
                    # .NET tool manifest dosyasını oluştur (varsa hata vermez)
                    dotnet new tool-manifest || true

                    # ArfBlocks CLI'yi proje içine kur
                    dotnet tool install Arfware.ArfBlocks-cli --version 2.0.0 || true

                    # Varsa restore et
                    dotnet tool restore
                '''
            }
        }

        stage('Create Output Folders') {
            steps {
                sh '''
                    # IAM modülü için klasör ve index.ts kontrolü
                    IAM_DIR="webapp/common/hirovo-api/src/api/base_modules/iam"
                    mkdir -p "$IAM_DIR"
                    if [ ! -f "$IAM_DIR/index.ts" ]; then
                        echo "// Generated by Jenkins" > "$IAM_DIR/index.ts"
                    fi

                    # Worker modülü için klasör ve index.ts kontrolü
                    WORKER_DIR="webapp/common/hirovo-api/src/api/business_modules/workers"
                    mkdir -p "$WORKER_DIR"
                    if [ ! -f "$WORKER_DIR/index.ts" ]; then
                        echo "// Generated by Jenkins" > "$WORKER_DIR/index.ts"
                    fi
                '''
            }
        }

        stage('Generate IAM Docs') {
            steps {
                sh 'dotnet tool run arfblocks-cli exec --file _devops/arfblocks-cli/iam.arfblocks-cli.json'
            }
        }

        stage('Generate Workers Docs') {
            steps {
                sh 'dotnet tool run arfblocks-cli exec --file _devops/arfblocks-cli/hirovo.arfblocks-cli.json'
            }
        }
    }
}
